name: 'Deploy'
on:
  push:
    branches: ['master']
permissions:
  id-token: 'write'
  contents: 'read'
concurrency:
  group: '${{ github.workflow }}-${{ github.ref }}'
  cancel-in-progress: true
jobs:
  starlet:
    name: 'Starlet'
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Check out'
        uses: 'actions/checkout@v5'
      - name: 'Set up Go'
        uses: 'actions/setup-go@v6'
        with:
          go-version-file: 'go.mod'
      - name: 'Build'
        run: |
          mkdir -p build/bin build/etc/systemd/system
          go build -ldflags="-s -w -buildid=" -trimpath -o build/bin/starlet ./cmd/starlet
          cp cmd/starlet/starlet.service build/etc/systemd/system
          tar -czf archive.tar.gz -C build .
      - name: 'Deploy'
        run: 'go tool deploy -type service starlet archive.tar.gz'
